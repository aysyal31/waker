#!/usr/bin/env ruby
require_relative '../config/environment'

logger = Logger.new(STDOUT)
Rails.logger = logger

watchers = []

while true
  watchers.each do |watcher|
    begin
      watcher.provider.reload
    rescue ActiveRecord::RecordNotFound
      watcher.stop
      logger.info "#{watcher} stopped"
    end
  end
  
  # add new watchers
  Provider.all.each do |provider|
    watcher = watchers.find do |w|
      w.provider == provider
    end
    next if watcher

    watcher = provider.watcher
    next unless watcher
    watchers << watcher
    Thread.start(watcher) do |w|
      begin
        w.start
        logger.debug "#{w} finished."
      rescue Exception => err
        backtrace = err.backtrace.join("\n")
        logger.error "#{err}\n#{backtrace}"
      ensure
        watchers.delete(w)
      end
    end
    logger.info "#{watcher} started"
  end

  sleep 10
end

